# ---------- Stage 1: Build ----------
FROM eclipse-temurin:17-jdk-alpine AS builder

WORKDIR /build

# Copy gradle files first (better caching)
COPY gradle gradle
COPY gradlew .
COPY settings.gradle .
COPY app/build.gradle app/build.gradle

RUN chmod +x gradlew

# Download dependencies (cached layer)
RUN ./gradlew dependencies --no-daemon || true

# Copy source code
COPY app/src app/src

# Build fat jar
RUN ./gradlew :app:shadowJar --no-daemon

# ---------- Stage 2: Runtime ----------
FROM eclipse-temurin:17-jre-alpine

WORKDIR /app

# Copy jar from builder
COPY --from=builder /build/app/build/libs/*.jar app.jar

# Reduce container attack surface
RUN addgroup -S appgroup && adduser -S appuser -G appgroup
USER appuser

ENTRYPOINT ["java", "-jar", "/app/app.jar"]